name: Bump Formulae and Casks

on:
  push:
    paths:
      - "auto_bump/*.txt"
      - ".github/workflows/bump.yml"
  schedule:
    - cron: "20 8,20 * * *"
  workflow_dispatch:

defaults:
  run:
    shell: bash

permissions:
  contents: read

jobs:
  bump:
    name: Auto Bump
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        type:
          - formula
          - cask

    steps:
      - name: Set up Homebrew
        id: set-up-homebrew
        uses: Homebrew/actions/setup-homebrew@master
        with:
          core: false
          cask: false
          test-bot: false

      - name: Cache Homebrew Bundler RubyGems
        id: cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.set-up-homebrew.outputs.gems-path }}
          key: ${{ runner.os }}-rubygems-${{ steps.set-up-homebrew.outputs.gems-hash }}
          restore-keys: ${{ runner.os }}-rubygems-

      - name: Install Homebrew Bundler RubyGems
        if: steps.cache.outputs.cache-hit != 'true'
        run: brew install-bundler-gems

      - name: Configure Git User
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Auto Bump
        env:
          HOMEBREW_LIVECHECK_WATCHLIST: ${{ github.workspace }}/auto_bump/${{ matrix.type }}.txt
          HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.MAA_HOMEBREW_BUMP_PR }}
        run: |
          info=$(brew livecheck --newer-only --${{ matrix.type }} --json)
          len=$(echo "$info" | jq length)
          for ((i=0; i < "$len"; i++)); do
            name=$(echo "$info" | jq -r ".[$i].${{ matrix.type }}")
            version=$(echo "$info" | jq -r ".[$i].version.latest")
            echo "Bumping \`$name\` to \`$version\`"
            brew bump-${{ matrix.type }}-pr "maaassistantarknights/tap/$name" \
              --no-audit \
              --no-browse \
              --version="$version" \
              --message="Bump \`$name\` to \`$version\`"
          done
